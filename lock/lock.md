# 同步相关

# 如何实现同步
## 1.synchronize
    1.同步代码块
    2.同步方法
        对于非静态的方法，锁的对象是this,静态方法锁对象是class对象。

### 实现方式
    通过javap查看字节码，代码块是通过monitor enter,monitor exit实现的。
    对于同步方法是在方法中有一个ACC_SYNC的标记。两者的实现都是一样的。
    锁状态的信息，都保存在对象头中。
    对锁的升级是（无锁）->偏向锁->轻量级锁->重量级锁
    在底层实现互斥是通过一个 wait set,当有多个线程竞争锁时，没有得到锁的对象回加到这个set中。
    锁信息的查看可以通过jol这个库查看。
    


## 2.lock
    实现公平锁和非公平锁
    读写锁
    可中断
    可重入


## 3相关的几个概念
    1.逃逸分析：jvm是通过-XX:+DoEscapeAnalysis开启，默认是开启。方法栈上的对象，只会在当前的栈帧中效，当前的方法执行完毕后，对象就会回收。
        验证时，可以通过，jmap -histo 查看当前对象的数量
        '''
            public static void main(String[] args){
                for(int i =0;i<500000;i++){
                    new CustomObject();
                }
            }
        '''
    2.对象标化：是基于逃逸分析的一种优化。如果某个对象的访问方式不要求该对象是一个连续的内存结构，那么对象的部分（或全部）可以不存储在内存，而是存储在CPU寄存器中。
    3.同步消除：是基于逃逸分析的一种优化。如果发现某个对象只能从一个线程可访问，那么在这个对象上的操作可以不需要同步。
    4.锁的粗化：将可以合并的同步代码合并，减少锁的开户释放成本。